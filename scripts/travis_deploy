#!/bin/bash

# Login to Google Container Registry using encrypted keyfile
docker login -u _json_key --password-stdin https://"$REGISTRY_HOSTNAME" < keyfile.json

# Build the Docker Image
docker build -f travis.Dockerfile -t "$PROJECT_NAME" .

# Push the image to Google Container Registry
docker tag "$PROJECT_NAME" "$REGISTRY_HOSTNAME"/"$PROJECT_NAME"/"$PROJECT_NAME":latest
docker push "$REGISTRY_HOSTNAME"/"$PROJECT_NAME"/"$PROJECT_NAME":latest

docker tag "$PROJECT_NAME" "$REGISTRY_HOSTNAME"/"$PROJECT_NAME"/"$PROJECT_NAME":"$PROJECT_VERSION"
docker push "$REGISTRY_HOSTNAME"/"$PROJECT_NAME"/"$PROJECT_NAME":"$PROJECT_VERSION"

terraform init $TF_INIT_CLI_OPTIONS
terraform apply $TF_APPLY_CLI_OPTIONS
