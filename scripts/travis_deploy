#!/bin/bash

# Build the Docker Image
docker build -f travis.Dockerfile -t $PROJECT_NAME .

# Login to Google Container Registry using encrypted keyfile
cat keyfile.json | docker login -u _json_key --password-stdin https://$REGISTRY_HOSTNAME

# Push the image to Google Container Registry
docker tag $PROJECT_NAME $REGISTRY_HOSTNAME/$PROJECT_NAME/$PROJECT_NAME:latest
docker push $REGISTRY_HOSTNAME/$PROJECT_NAME/$PROJECT_NAME:latest

docker tag $PROJECT_NAME $REGISTRY_HOSTNAME/$PROJECT_NAME/$PROJECT_NAME:$PROJECT_VERSION
docker push $REGISTRY_HOSTNAME/$PROJECT_NAME/$PROJECT_NAME:$PROJECT_VERSION

terraform apply -auto-approve -input=false
